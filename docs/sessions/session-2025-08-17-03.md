# Session 03 — 2025-08-17 — Add earnings embargo gate

## Part 1 — Development
- **Theme:** Add earnings embargo gate
- **Acceptance:** Symbol within earnings embargo window → BUY converts to HOLD with earnings_embargo soft gate
- **Rails:** `TRADING_MODE=paper` | `GLOBAL_PAUSE=false` 
- **Contracts touched:** None (uses fixtures)
- **Changes:**
  - Code: `internal/config/config.go`, `internal/decision/engine.go`, `cmd/decision/main.go`
  - Config: Added `earnings` section with enabled/block_on_estimated/minutes_before/minutes_after
  - Fixtures: Updated `fixtures/earnings_calendar.json` with test data
  - Tests: Added Session 5 test case in `scripts/run-tests.sh`

### Implementation notes
- Implemented as **soft gate** (BUY→HOLD) rather than hard gate, preserving ability to REDUCE positions during embargo
- UTC time handling with configurable buffers (30 min before/after by default)  
- Status-aware: respects confirmed vs estimated events based on `block_on_estimated` config
- Rich decision context includes embargo window details and what_would_change_it guidance
- Composable with other gates (corroboration, session, liquidity, etc.)

---

## Part 2 — Test Run & Edge Cases
### Commands
```bash
# Test earnings embargo (symbol in window → HOLD)
go run ./cmd/decision -config config_resumed.yaml -earnings fixtures/earnings_calendar.json -oneshot=true

# Test normal behavior (no embargo → BUY)  
go run ./cmd/decision -config config_resumed.yaml -earnings empty_calendar.json -oneshot=true

# metrics
curl -s localhost:8090/metrics | jq .earnings_embargo_blocks_total
```

### Evidence
```json
// AAPL with earnings embargo active
{
  "symbol": "AAPL",
  "intent": "HOLD", 
  "gates_blocked": ["earnings_embargo"],
  "earnings_embargo": {
    "start_utc": "2025-08-17T19:00:00Z",
    "end_utc": "2025-08-18T01:00:00Z", 
    "status": "confirmed"
  },
  "what_would_change": "wait until 2025-08-18T01:00:00Z"
}

// AAPL without earnings embargo  
{
  "symbol": "AAPL",
  "intent": "BUY_1X",
  "gates_blocked": [],
  "earnings_embargo": null
}
```

### Edge Cases Verified
- ✅ **Soft gate behavior**: BUY→HOLD, REDUCE unaffected
- ✅ **Time window calculation**: Buffers applied correctly (start-30min to end+30min)
- ✅ **Status handling**: Confirmed events blocked, estimated events ignored when `block_on_estimated=false`
- ✅ **Composability**: Works alongside corroboration, session, liquidity gates
- ✅ **Rich context**: Embargo details and guidance in decision reason (`what_would_change_it`)
- ✅ **Metrics**: `earnings_embargo_blocks_total` counter incremented
- ✅ **Control cases**: No embargo → BUY_1X intent, earnings_embargo=null
- ✅ **Estimated earnings**: Ignored when `block_on_estimated=false` (default behavior)

## Part 3 — Test Coverage Summary

### Automated Test Cases Added
1. **Session 5 Earnings Embargo Test** (`scripts/run-tests.sh`):
   - Sets up clean market conditions (no session/liquidity conflicts)
   - Creates earnings calendar with AAPL in active embargo window
   - Verifies: AAPL intent = HOLD, gates_blocked contains "earnings_embargo"
   - Validates: Rich embargo context in decision reason

### Manual Test Cases Verified
2. **Control Test** (No Embargo):
   - AAPL with past/inactive earnings window → BUY_1X intent
   - earnings_embargo field = null in decision reason

3. **Estimated Earnings Test**:
   - AAPL with status="estimated" and block_on_estimated=false → BUY_1X intent  
   - Confirms estimated events are ignored as configured

4. **Integration Test**:
   - Earnings embargo composable with other gates (halt, liquidity, corroboration)
   - Multiple symbols with different gate combinations work correctly

### Test Commands for Verification
```bash
# Test earnings embargo active
go run ./cmd/decision -config config_resumed.yaml -earnings embargo_active.json -oneshot=true

# Test no embargo  
go run ./cmd/decision -config config_resumed.yaml -earnings embargo_past.json -oneshot=true

# Test estimated earnings (should be ignored by default)
go run ./cmd/decision -config config_resumed.yaml -earnings embargo_estimated.json -oneshot=true
```
