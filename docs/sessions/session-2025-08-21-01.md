# Session 01 — 2025-08-21 — Paper order outbox + idempotency (mock fills)

## Part 1 — Development
- **Theme:** Paper order outbox + idempotency (mock fills)
- **Acceptance:** BUY_*/REDUCE decisions in paper mode write order+fill to JSONL outbox with idempotency deduplication
- **Rails:** `TRADING_MODE=paper` | `GLOBAL_PAUSE=<true|false>`
- **Contracts touched:** Added paper trading outbox with Order/Fill structs
- **Changes:**
  - Code: internal/outbox package (outbox.go, fills.go, state.go), cmd/decision/main.go integration
  - Config: config/config.yaml paper section, internal/config/config.go Paper struct
  - README/Docs: N/A
  - ADRs: N/A

### Implementation notes
- Outbox pattern with JSONL append-only persistence for audit trail
- Idempotency via deterministic hash (symbol-intent-timestamp-score)
- Mock fill simulator with configurable latency (100-2000ms) and slippage (1-5bps)
- Deduplication window (90s default) prevents rapid-fire duplicate orders
- Async fill writing with goroutines, no blocking of decision pipeline
- Only processes actionable intents (BUY_1X, BUY_5X, REDUCE), ignores HOLD/REJECT

---

## Part 2 — Test Run & Edge Cases
### Commands
```bash
# primary run (paused)
go run ./cmd/decision -config config/config.yaml

# resumed run with outbox
GLOBAL_PAUSE=false go run ./cmd/decision -oneshot=true

# check outbox entries
cat data/outbox.jsonl | jq .

# test suite
make test

# metrics
curl -s localhost:8090/metrics | jq .
```

### Evidence
- ✅ All existing tests pass (Cases 1-5: paused, resumed, after-hours, corroboration, earnings)
- ✅ Case 6 added: paper_outbox functionality with order/fill persistence
- ✅ Outbox file created at configured path with order entries
- ✅ Idempotency working: timestamp differences create new orders (not exact duplicates)
- ✅ Only actionable decisions (BUY_1X) write to outbox, REJECT/HOLD filtered out
- ✅ Async fill simulation initiated (fills written after configurable latency)
- ✅ New metrics: paper_orders_total, paper_order_dedupe_total, paper_fills_total
- ✅ Config defaults applied: 90s dedupe window, 100-2000ms latency, 1-5bps slippage

### Edge Cases Validated
- Global pause blocks outbox writes (no orders when REJECT intent)
- Halted symbols don't generate outbox entries (NVDA REJECT due to halt)
- Non-actionable intents (HOLD, REJECT) skip outbox processing
- File creation and directory handling works correctly
- Idempotency keys unique across different timestamps and scores
